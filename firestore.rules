rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    function isCreator() {
      return hasRole('creator') || hasRole('admin');
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function isTourOwner(tourId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/tours/$(tourId)).data.creatorId == request.auth.uid;
    }

    function isTourApproved(tourId) {
      return get(/databases/$(database)/documents/tours/$(tourId)).data.status == 'approved';
    }

    // Check if update only modifies stats fields (for play counts, ratings, etc.)
    function onlyUpdatesStats() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(['stats', 'stats.totalPlays', 'stats.totalDownloads',
                                   'stats.averageRating', 'stats.totalRatings']);
    }

    // ============================================
    // USERS COLLECTION
    // ============================================

    match /users/{userId} {
      // Anyone authenticated can read user profiles (for displaying names, etc.)
      allow read: if isAuthenticated();

      // Users can create their own profile
      allow create: if isOwner(userId) &&
        request.resource.data.role == 'user'; // New users start as 'user' role

      // Users can update their own profile (but not change their role)
      allow update: if isOwner(userId) &&
        request.resource.data.role == resource.data.role; // Cannot change own role

      // Admins can update any user (including role changes)
      allow update: if isAdmin();

      // Only admins can delete users
      allow delete: if isAdmin();

      // User tour progress
      match /progress/{progressId} {
        allow read, write: if isOwner(userId);
      }

      // User downloads
      match /downloads/{downloadId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // TOURS COLLECTION
    // ============================================

    match /tours/{tourId} {
      // Public can read approved tours
      // Creators can read their own tours
      // Admins can read all tours
      allow read: if resource.data.status == 'approved' ||
        (isAuthenticated() && resource.data.creatorId == request.auth.uid) ||
        isAdmin();

      // Only creators and admins can create tours
      allow create: if isCreator() &&
        request.resource.data.creatorId == request.auth.uid &&
        request.resource.data.status == 'draft';

      // Tour owners can update their tours (but not change status to 'approved')
      // Authenticated users can update only stats (for play counts, ratings)
      allow update: if (isAuthenticated() && resource.data.creatorId == request.auth.uid &&
        request.resource.data.status != 'approved') ||
        isAdmin() ||
        // Allow authenticated users to update only stats fields
        (isAuthenticated() && onlyUpdatesStats());

      // Only admins can delete tours
      allow delete: if isAdmin();

      // ============================================
      // TOUR VERSIONS SUBCOLLECTION
      // ============================================

      match /versions/{versionId} {
        // Same read rules as parent tour
        allow read: if get(/databases/$(database)/documents/tours/$(tourId)).data.status == 'approved' ||
          isTourOwner(tourId) ||
          isAdmin();

        // Tour owners can create/update versions
        allow create, update: if isTourOwner(tourId) || isAdmin();

        // Only admins can delete versions
        allow delete: if isAdmin();

        // ============================================
        // STOPS SUBCOLLECTION
        // ============================================

        match /stops/{stopId} {
          // Same read rules as parent version
          allow read: if isTourApproved(tourId) ||
            isTourOwner(tourId) ||
            isAdmin();

          // Tour owners can create/update/delete stops
          allow create, update, delete: if isTourOwner(tourId) || isAdmin();
        }
      }

      // ============================================
      // TOUR REVIEWS SUBCOLLECTION
      // ============================================

      match /reviews/{reviewId} {
        // Anyone can read reviews of approved tours
        allow read: if isTourApproved(tourId);

        // Authenticated users can create reviews for approved tours
        allow create: if isAuthenticated() &&
          isTourApproved(tourId) &&
          request.resource.data.userId == request.auth.uid;

        // Users can update/delete their own reviews
        allow update, delete: if isAuthenticated() &&
          resource.data.userId == request.auth.uid;

        // Admins can delete any review
        allow delete: if isAdmin();
      }
    }

    // ============================================
    // REVIEW QUEUE (Admin Only)
    // ============================================

    match /reviewQueue/{queueId} {
      allow read, write: if isAdmin();
    }

    // ============================================
    // REVIEW COMMENTS (Admin Only)
    // ============================================

    match /reviewComments/{commentId} {
      // Admins can read all review comments
      allow read: if isAdmin();

      // Admins can create comments
      allow create: if isAdmin() &&
        request.resource.data.authorId == request.auth.uid;

      // Admins can update comments (e.g., resolve them)
      allow update: if isAdmin();

      // Admins can delete their own comments
      allow delete: if isAdmin() &&
        resource.data.authorId == request.auth.uid;
    }

    // ============================================
    // RATE LIMITS (Cloud Functions Only)
    // ============================================

    match /rateLimits/{document=**} {
      // Users can read their own rate limit status
      allow read: if isAuthenticated();

      // Only Cloud Functions can write (no client writes)
      allow write: if false;
    }

    // ============================================
    // APP CONFIGURATION
    // ============================================

    match /config/{docId} {
      // Everyone can read app config
      allow read: if true;

      // Only admins can modify config
      allow write: if isAdmin();
    }

    // ============================================
    // PUBLISHING SUBMISSIONS (New for Tour Manager Rebuild)
    // ============================================

    match /publishingSubmissions/{submissionId} {
      // Creators can read their own submissions
      // Admins can read all submissions
      allow read: if isAuthenticated() &&
        (resource.data.creatorId == request.auth.uid || isAdmin());

      // Creators can create submissions for their own tours
      allow create: if isCreator() &&
        request.resource.data.creatorId == request.auth.uid &&
        request.resource.data.status == 'submitted';

      // Creators can update their own submissions (withdraw, resubmit)
      // Admins can update any submission (review actions)
      allow update: if isAuthenticated() &&
        (resource.data.creatorId == request.auth.uid || isAdmin());

      // Only admins can delete submissions
      allow delete: if isAdmin();

      // Review Feedback subcollection
      match /reviewFeedback/{feedbackId} {
        // Creators can read feedback on their submissions
        // Admins can read all feedback
        allow read: if isAuthenticated() &&
          (get(/databases/$(database)/documents/publishingSubmissions/$(submissionId)).data.creatorId == request.auth.uid || isAdmin());

        // Only admins can create feedback
        allow create: if isAdmin() &&
          request.resource.data.reviewerId == request.auth.uid;

        // Only admins can update feedback
        allow update: if isAdmin();

        // Only admins can delete feedback
        allow delete: if isAdmin();
      }
    }

    // ============================================
    // COLLECTIONS (Curated Tour Collections)
    // ============================================

    match /collections/{collectionId} {
      // Anyone can read collections
      allow read: if true;

      // Only admins can create/update/delete collections
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // ANALYTICS (Tour Analytics)
    // ============================================

    match /analytics/{tourId} {
      // Tour owners can read their own analytics
      // Admins can read all analytics
      allow read: if isAuthenticated() &&
        (isTourOwner(tourId) || isAdmin());

      // Only Cloud Functions can write (no client writes)
      allow write: if false;

      // Analytics periods subcollection
      match /periods/{periodId} {
        allow read: if isAuthenticated() &&
          (isTourOwner(tourId) || isAdmin());

        // Only Cloud Functions can write
        allow write: if false;
      }
    }

    // ============================================
    // TOUR VERSIONS (Standalone Collection for Routes)
    // ============================================

    match /versions/{versionId} {
      // Read if user owns the tour or is admin
      allow read: if isAuthenticated();

      // Tour owners and admins can write
      allow write: if isCreator() || isAdmin();

      // Routes subcollection
      match /routes/{routeId} {
        allow read: if isAuthenticated();
        allow write: if isCreator() || isAdmin();

        // Waypoints subcollection
        match /waypoints/{waypointId} {
          allow read: if isAuthenticated();
          allow write: if isCreator() || isAdmin();
        }
      }
    }

    // ============================================
    // VOICE GENERATIONS
    // ============================================

    match /stops/{stopId}/voiceGenerations/{voiceGenId} {
      // Creators can read their own voice generations
      allow read: if isAuthenticated();

      // Creators can create/update voice generations
      allow create, update: if isCreator();

      // Only Cloud Functions can write completion status
      // Creators can delete
      allow delete: if isCreator() || isAdmin();
    }

    // ============================================
    // TOUR PROGRESS (Collection Group for Analytics)
    // ============================================

    match /{path=**}/tourProgress/{progressId} {
      // Users can read/write their own progress
      allow read, write: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================
    // DOWNLOADS (Collection Group for Analytics)
    // ============================================

    match /{path=**}/downloads/{downloadId} {
      // Users can read their own downloads
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Users can create downloads
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // Users can update/delete their own downloads
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================
    // FAVORITES (Collection Group for Analytics)
    // ============================================

    match /{path=**}/favorites/{favoriteId} {
      // Users can read their own favorites
      allow read: if isAuthenticated();

      // Users can create/delete favorites
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AUDIT LOGS (Admin Only)
    // ============================================

    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();

      // Only Cloud Functions can write
      allow write: if false;
    }
  }
}
